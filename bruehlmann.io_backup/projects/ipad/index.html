<!DOCTYPE html>
<html lang="en"><head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="Florian Brühlmann">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<title>iPad Ausleihe</title>

	<script type="text/javascript" src="assets/jQuery.min.js"></script>
	<script type="text/javascript" src="assets/bootstrap.bundle.min.js"></script>
	<!-- <script type="text/javascript" src="assets/instascan.min.js"></script> -->
	<!-- <script type="text/javascript" src="assets/qrcodelib.js"></script> -->
    <!-- <script type="text/javascript" src="assets/webcodecamjs.js"></script> -->
    <script type="text/javascript" src="assets/jsQR.js"></script>
        <!-- 
            Using jquery version:
            <script type="text/javascript" src="js/jquery.js"></script>
            <script type="text/javascript" src="js/qrcodelib.js"></script>
            <script type="text/javascript" src="js/webcodecamjquery.js"></script>
        -->
	<script type="text/javascript" src="assets/jSignature.min.js"></script>

	<script>
		$(document).ready(function() {
			$("#signature").jSignature();


			// $( "#target" ).submit(function( event ) {
			// 	alert( "Handler for .submit() called." );
			// 	console.log($("#signature").jSignature("getData","svgbase64"));
			// 	event.preventDefault();
			// });


			$( "#reset" ).click(function() {
				console.log("reset");
				$("#signature").jSignature("reset");
			});
			$( "#resetsignature" ).click(function() {
				console.log("reset");
				$("#signature").jSignature("reset");
			});


			function addAlert(message
				) {
				$('#alerts').append(
					'<div class="alert alert-success alert-dismissible fade show" role="alert">' +
					message + 
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>'
					);
			}

			/* Form handler*/

			// Variable to hold request
			var request;

			// Bind to the submit event of our form
			$("#target").submit(function(event){

		    // Prevent default posting of form - put here to work in case of errors
		    event.preventDefault();

		    // Abort any pending request
		    if (request) {
		    	request.abort();
		    }
		    // setup some local variables
		    var $form = $(this);

		    // Let's select and cache all the fields
		    var $inputs = $form.find("input, select, button, textarea");
		    var $usersignature = $("#signature").jSignature("getData","svgbase64");
		    var $usersignature2 = $("#signature").jSignature("getData","svgbase64");

		    // Serialize the data in the form
		    var serializedData = $form.serialize();

		    serializedData = serializedData + "&sigType=" + $usersignature[0] + "&sigData=" + $usersignature[1];

		    // Let's disable the inputs for the duration of the Ajax request.
		    // Note: we disable elements AFTER the form data has been serialized.
		    // Disabled form elements will not be serialized.
		    //  $inputs.prop("disabled", true);

		    // // Fire off the request to /form.php
		    //  request = $.ajax({
		    // 	url: "handler.php",
		    // 	type: "post",
		    // 	data: serializedData
		    // });

		    // // Callback handler that will be called on success
		    // request.done(function (response, textStatus, jqXHR){
		    //     // Log a message to the console
		    //     console.log("Hooray, it worked!");
		    // });

		    // // Callback handler that will be called on failure
		    // request.fail(function (jqXHR, textStatus, errorThrown){
		    //     // Log the error to the console
		    //     console.error(
		    //     	"The following error occurred: "+
		    //     	textStatus, errorThrown
		    //     	);
		    // });

		    // // Callback handler that will be called regardless
		    // // if the request failed or succeeded
		    // request.always(function () {
		    //     // Reenable the inputs
		    //     $inputs.prop("disabled", false);
		    // });

		    // TODO:
		    // Find values in correct forms
		    // add values to the string which will be posted
		    // change date to correct format
		    // post to Trello

		    var date = $form.find("#inputDate").val();
		    var dateSplit = date.split('-');

		    var newDate = dateSplit[1] + '/' + dateSplit[2] + '/' + dateSplit[0];

		    var inputName = $form.find("#inputName").val();
		    var inputVorname = $form.find("#inputVorname").val();
		    var inputEmail = $form.find("#inputEmail").val();
		    var inputDevices = $form.find("#inputDevices").val();
		    var inputType = $form.find("#inputType").val();


		    var description = "#" + inputVorname + " " + inputName + "\n\n" + "Email: " + inputEmail + "" + "\n\n" + "- Typ: "+ inputType +"\n" + "Geräte: __" + inputDevices + "__\n\n" + "Rückgabedatum: " + date + "\n" + "[Unterschrift](https://bruehlmann.io/projects/ipad/datauri.php?data=" + encodeURIComponent($usersignature2.join(",")) + ")";


		    var dataPOST = {name:  "Ausleihe " + inputVorname +" "+ inputName, 
		    desc: description,
		    pos: "top",
		    due: newDate,
		    dueComplete: false,
		    idList: "5cb5b646b64cdb0e1c3f32c6",
		    idLabels: "5cb5bc938ccb507176ac5cdc",
		    keepFromSource: "all",
		    key: "dbb2fa4c26500e07e1e09792d19e6171",
		    token: "b459db49519d67e0b420784bd75004fe7840af991020f55b1fa7b5dd41655e17"
		};

		var data = null;

		var xhr = new XMLHttpRequest();

		xhr.addEventListener("readystatechange", function () {
			if (this.readyState === this.DONE) {
				console.log(this.responseText);
				addAlert("Eintrag gespeichert");
			}
		});

		xhr.open("POST", "https://api.trello.com/1/cards?"+$.param(dataPOST));

		xhr.send(data);

	});


		})




	</script>

	<link rel="canonical" href="https://getbootstrap.com/docs/4.3/examples/floating-labels/">


	<!-- Bootstrap core CSS -->
	<link href="assets/bootstrap.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	<link href="assets/all.min.css" rel="stylesheet">

	<style>
		.bd-placeholder-img {
			font-size: 1.125rem;
			text-anchor: middle;
			-webkit-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
		}

		@media (min-width: 768px) {
			.bd-placeholder-img-lg {
				font-size: 3.5rem;
			}
		}
	</style>
	<!-- Custom styles for this template -->
	<link href="assets/floating-labels.css" rel="stylesheet">
</head>
<body>
	<form id="target" class="form-signin" data-op-form-id="0" action="handler.php">
		<div class="text-center mb-4">
			<!-- <img class="mb-4" src="assets/bootstrap-solid.svg" alt="" width="72" height="72"> -->
			<span style="font-size: 72px; color: Dodgerblue;">
				<i class="fas fa-tablet"></i>
			</span>
			<h1 class="h3 mb-3 font-weight-normal">iPad Ausleihe</h1>
		</div>

		<div class="form-label-group">
			<input type="text" id="inputVorname" name="inputVorname" class="form-control" placeholder="Vorname" required="" autofocus="">
			<label for="inputVorname">Vorname</label>
		</div>

		<div class="form-label-group">
			<input type="text" id="inputName" name="inputName" class="form-control" placeholder="Name" required="">
			<label for="inputName">Name</label>
		</div>

		<div class="form-label-group">
			<input type="email" id="inputEmail" name="inputEmail" class="form-control" placeholder="Email" required="" data-op-id="0">
			<label for="inputEmail">Email</label>
		</div> 

		<div class="form-label-group">
			<div class="custom-control custom-switch">
				<input type="checkbox" class="custom-control-input" id="customSwitch1">
				<label class="custom-control-label" for="customSwitch1">QR code reader</label>
			</div>
		</div>


		<div class="form-label-group" style="margin-right: auto; margin-left: auto; width: 240px;">
		    <!-- <canvas id="webcodecam-canvas" style="display: none;"></canvas> -->
  			<canvas id="canvas" hidden></canvas>

		<!-- 	<script type="text/javascript">
				$(function() {
					$('#customSwitch1').change(function() {

						if($(this).prop('checked')) {
							console.log("on");
							$("#preview").show();

							let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

							scanner.addListener('scan', function (content) {
								console.log(content);
								if($("#inputDevice").val().length === 0) {
									$("#inputDevice").val(content);
								} else {
									$("#inputDevice").val($("#inputDevice").val() + ", " + content);
								}

							});
							Instascan.Camera.getCameras().then(function (cameras) {
								console.log(cameras);
								if (cameras.length > 0) {
									if(cameras.length > 1) {
										scanner.start(cameras[1]);
									} else {
										scanner.start(cameras[0]);
									}
								} else {
									console.error('No cameras found.');
								}
							}).catch(function (e) {
								console.error(e);
							});

						} else {

							console.log("off");
							$("#preview").hide();
	     		// scanner.stop();

	     	}
	     })
				})

			</script> -->
		</div>

		<div class="form-label-group">
			<input type="text" id="inputDevices" name="inputDevices" class="form-control" placeholder="Geräte" required="">
			<label for="inputDevices">Geräte</label>
		</div> 


  <div id="output" hidden>
    <div id="outputMessage">No QR code detected.</div>
    <div hidden><b>Data:</b> <span id="outputData"></span></div>
  </div>
  <script>
    var video = document.createElement("video");
    var canvasElement = document.getElementById("canvas");
    var canvas = canvasElement.getContext("2d");
    var loadingMessage = document.getElementById("loadingMessage");
    var inputDevicesElem = $("#inputDevices");

    function drawLine(begin, end, color) {
      canvas.beginPath();
      canvas.moveTo(begin.x, begin.y);
      canvas.lineTo(end.x, end.y);
      canvas.lineWidth = 4;
      canvas.strokeStyle = color;
      canvas.stroke();
    }
    // Use facingMode: environment to attemt to get the front camera on phones
   $('#customSwitch1').change(function() {
			if($(this).prop('checked')) {
				  navigator.mediaDevices.getUserMedia(
				  	{ video: 
				  		{ facingMode: "environment",
				  			width: { ideal: 320 },
    						height: { ideal: 240 }
						} 

				  	}
				).then(function(stream) {
				      video.srcObject = stream;
				      video.setAttribute("playsinline", true); // required to tell iOS safari we don't want fullscreen
				      video.play();
				      requestAnimationFrame(tick);
			    });

			} else {
				video.srcObject.getTracks().forEach(track => track.stop())
				// video.pause();
				canvasElement.hidden = true;
			}
		});

    function tick() {
     
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.hidden = false;
        // outputContainer.hidden = false;
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        var imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        var code = jsQR(imageData.data, imageData.width, imageData.height, {
          inversionAttempts: "dontInvert",
        });
        if (code) {
          drawLine(code.location.topLeftCorner, code.location.topRightCorner, "#FF3B58");
          drawLine(code.location.topRightCorner, code.location.bottomRightCorner, "#FF3B58");
          drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner, "#FF3B58");
          drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner, "#FF3B58");
          // outputMessage.hidden = true;
          // outputData.parentElement.hidden = false;
          // outputData.val() = code.data;
          if(inputDevicesElem.val().length === 0) {
									inputDevicesElem.val(code.data);
			} else {
				var items = inputDevicesElem.val().split(/\s*,\s*/);
				var isContained = items.some(function(v) { return v === code.data; });
				if(isContained) {
						console.log("QR code already exists");
				} else {
						inputDevicesElem.val(inputDevicesElem.val() + ", " + code.data);
						}
				}
        } else {
          // outputMessage.hidden = false;
          // outputData.parentElement.hidden = true;
        }
      }
      requestAnimationFrame(tick);
    }
  </script>		

<!--         <script type="text/javascript">
            var arg = {
                resultFunction: function(result) {
                	console.log($("#inputDevices").val);
								if($("#inputDevices").val().length === 0) {
									$("#inputDevices").val(result.code);
								} else {
									$("#inputDevices").val($("#inputDevices").val() + ", " + result.code);
								}
							},
				beep: 'audio/beep.mp3', 
				decoderWorker: 'assets/DecoderWorker.js'
            };
            var decoder = new WebCodeCamJS("canvas").init(arg);
            $('#customSwitch1').change(function() {
            	if($(this).prop('checked')) {
            		$("#webcodecam-canvas").show();
            		decoder.play();
            	} else {
            		decoder.stop();
            		$("#webcodecam-canvas").hide();
            	}

            });


        </script> -->

				<div class="form-group">
			<select id="inputType" class="custom-select my-1 mr-sm-2" id="inlineFormCustomSelectPref">
				<option selected value="iPad">iPad</option>
				<option value="Anderes">Anderes</option>
			</select>
		</div>

		<div class="form-label-group">
			<input type="date" id="inputDate" name="inputDate" class="form-control" placeholder="Rückgabedatum" required="">
			<label for="inputDate">Rückgabedatum</label>
		</div>
		<label for="signature">Unterschrift</label>
		<div class="form-label-group pb-3">
			<div id="signature"></div>
		</div>




		<div class="checkbox mb-3">
			<label>
				<input type="checkbox" name="agreement" required value="true"> Ich stimme den <a href="#bestimmungen" data-toggle="modal" data-target="#bestimmungen">Ausleihebestimmungen</a> zu.
			</label>
		</div>
		<div class="mb-3">
			<button class="btn btn-lg btn-primary btn-block" type="submit">Absenden</button>
		</div>
		<div id="alerts"></div>		
		<div class="mb-3">
			<button id="resetsignature" type="button" class="btn btn-secondary btn-block btn-sm" >Unterschrift löschen</button>
			<button id="reset" type="reset" class="btn btn-light btn-block btn-sm" >Formular zurücksetzen</button>
		</div>
	</form>


	<!-- Modal -->
	<div class="modal fade" id="bestimmungen" tabindex="-1" role="dialog" aria-labelledby="bestimmungenTitle" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="bestimmungenTitle">Ausleihebestimmungen APS iPads FHNW</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
<h5>Allgemein</h5>
Mitarbeitende und Studierende der Hochschule für Angewandte Psychologie FHNW können für «Lehre und Forschung» Ausleihgeräte für max. 4 Wochen kostenlos beziehen. Eine längere Ausleihdauer ist in Ausnahmefällen auf Anfrage möglich. Die Benutzung der Ausleihgeräte aus-serhalb von «Lehre und Forschung» kann kostenpflichtig sein oder abgelehnt werden.
</p>
<h5>Anmeldung</h5>
<p>
Der Antrag ist mindestens 5 Arbeitstage im Voraus einzureichen. Da die Anzahl der Geräte be-grenzt ist, erfolgt die Zuteilung nach Verfügbarkeit. In den Prüfungszeiträumen (Januar-Februar und Juni-Juli) kann die Verfügbarkeit gewisser Geräte (insb. iPads) einge-schränkt werden.
</p>
<h5>Geräteabholung- und Rückgabe</h5>
<p>
Die Abholung und Rückgabe im Medienraum OVR B270, Von Rollstrasse 10, 4600 Olten nach vorheriger Absprache (elearning.aps@fhnw.ch). Die Geräterückgabe hat termingerecht und persönlich zu erfolgen.
</p>
<h5>Löschung</h5>
<p>
Das APS digital Team löscht alle Daten auf den Geräten nach der Rückgabe. Sicherung der Da-ten ist Sache der Benutzerin resp. des Benutzers. 
</p>
<h5>Haftung</h5>
<p>
Die Geräte sind nicht versichert. Die Benutzerin resp. der Benutzer haftet unter Schadener-satzpflicht für den ordnungs- und sachgemässen Gebrauch der Apparate. 
Es gilt das Reglement betreffend Nutzung der FHNW IT -Infrastruktur (IT-Reglement) abrufbar im Prozessmanagement System (https://pms.fhnw.ch -> Supportprozesse -> Informatik -> IT Security). 
</p>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal">Fenster schliessen</button>
				</div>
			</div>
		</div>
	</div>


</body></html>